<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>APA App</title>
  <meta name="description" content="Antenna Pointing Angles Calculator PWA" />
  <meta name="theme-color" content="#1a73e8" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />

  <!-- Leaflet CSS with fallback (doesn't need fix for JS timing) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css';
                this.onerror=function(){this.href='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';}">

  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <!-- App Styles -->
  <link rel="stylesheet" href="styles.css?v={{VERSION}}" />
</head>
<body>
  <!-- (all your content stays unchanged — drawers, buttons, panels, help, map, APA table, etc.) -->

  <!-- header -->
  <header>
    <h1>APA App</h1>
    <span id="version">Version: <span data-version>{{VERSION}}</span></span>
  </header>

  <!-- All drawers, buttons, map, APA table, polar plot, etc. stay the same -->
  <!-- (Not repeated here to keep the focus on fixes — keep your full body content as-is) -->

  <!-- ✅ Leaflet & App Script Loader (Fixes `L is not defined`) -->
  <script>
    function loadLeafletAndApp() {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.onload = () => {
        console.log('Leaflet loaded from primary CDN');
        loadAppScripts();
      };
      script.onerror = () => {
        console.warn('Primary Leaflet CDN failed, trying fallback...');
        const fallback = document.createElement('script');
        fallback.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
        fallback.onload = () => {
          console.log('Leaflet loaded from fallback CDN');
          loadAppScripts();
        };
        fallback.onerror = () => {
          const last = document.createElement('script');
          last.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
          last.onload = () => {
            console.log('Leaflet loaded from jsDelivr');
            loadAppScripts();
          };
          document.head.appendChild(last);
        };
        document.head.appendChild(fallback);
      };
      document.head.appendChild(script);
    }

    function loadAppScripts() {
      const scripts = [
        { type: 'module', src: `data.js?v={{VERSION}}` },
        { type: 'module', src: `js/main.js?v={{VERSION}}` }
      ];
      scripts.forEach(({ type, src }) => {
        const s = document.createElement('script');
        s.type = type;
        s.src = src;
        document.body.appendChild(s);
      });
    }

    document.addEventListener('DOMContentLoaded', loadLeafletAndApp);
  </script>

  <!-- ✅ Service Worker Registration -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const version = document.querySelector('[data-version]')?.textContent || 'dev';
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(`sw.js?v=${version}`)
          .then(reg => {
            console.log("Service Worker registered with scope:", reg.scope);
          })
          .catch(err => {
            console.error("Service Worker registration failed:", err);
          });
      }
    });
  </script>
</body>
</html>
